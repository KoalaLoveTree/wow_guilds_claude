# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Rust Discord bot for World of Warcraft guild rankings and mythic+ data. It's a rewrite of the original Python version with improved performance, memory safety, and maintainability. The bot fetches data from raider.io API and provides Discord slash commands for guild progression and player rankings.

## Essential Commands

### Development
```bash
# Run the Discord bot
cargo run

# Run the data parser (to generate member data from raider.io)
cargo run parse

# Check database status and migrations
cargo run db-status

# Build the project
cargo build

# Run tests
cargo test

# Check for lint issues
cargo clippy

# Format code
cargo fmt
```

### Database Operations
- The bot uses SQLite with automatic migrations on startup
- Data is populated automatically from `uaguildlist.txt` during first migration
- Use `cargo run db-status` to see database stats and migration history

## Architecture

### Core Components
- **main.rs**: Discord bot event handler, command routing, auto-role assignment
- **commands.rs**: Discord slash command implementations (`/guilds`, `/rank`, `/help`, etc.)
- **config.rs**: Configuration management with environment variable support
- **database.rs**: SQLite operations with migration system
- **raider_io.rs**: API client for raider.io with rate limiting and error handling
- **guild_data.rs**: Guild data fetching and processing logic
- **parser.rs**: Bulk data parsing from raider.io to populate member database
- **types.rs**: Type definitions and data structures
- **error.rs**: Centralized error handling
- **logging.rs**: Structured logging configuration

### Data Flow
1. Guild URLs are read from `uaguildlist.txt` 
2. Parser fetches guild members and mythic+ scores from raider.io API
3. Data is stored in SQLite database with complete RIO stats (all, dps, healer, tank, spec_0-3)
4. Discord commands query the database for real-time responses

### Configuration
- Uses hierarchical config: defaults → config file → environment variables
- Legacy environment variable support (DISCORD_TOKEN, etc.)
- Rate limiting optimized for raider.io API (50 req/sec, 25 concurrent)

## File Structure Requirements

### Required Data Files
- `.env`: Environment configuration (copy from `.env.example`)
- `uaguildlist.txt`: Guild URLs in format: `realm=Realm%20Name&name=Guild%20Name`
- `addCharacters.txt`: Additional characters in format: `PlayerName Server Name`

### Generated Files
- `wow_guild_bot.db`: SQLite database (auto-created)
- `members.json`: Generated by parser (legacy compatibility)

## Performance Notes

- Rate limiting optimized to match Python bot performance (3-5 seconds for 61 guilds)
- Concurrent API requests with intelligent batching
- Database migrations automatically populate guild data from `uaguildlist.txt`
- Complete RIO data structure supports all ranking queries

## Discord Commands
- `/guilds [season] [limit]`: Guild raid progression rankings
- `/rank [top] [guilds] [classes] [role] [rio]`: Player mythic+ rankings with advanced filtering
- `/about_us`, `/rules`, `/help`: Informational commands

## Development Workflow
1. Set up `.env` file with Discord token and optional raider.io API key
2. Create `uaguildlist.txt` with guild URLs
3. Run `cargo run parse` to populate member data
4. Run `cargo run` to start Discord bot
5. Use `cargo run db-status` to monitor database state

## Docker Deployment

### Building and Running Locally
```bash
# Build the Docker image
docker build -t wow-guild-bot .

# Run with environment file
docker run --env-file .env -v $(pwd)/data:/app/data wow-guild-bot

# Run with individual environment variables
docker run -e DISCORD_TOKEN=your_token -v $(pwd)/data:/app/data wow-guild-bot
```

### Dokku Deployment
```bash
# On Dokku server, create the app
dokku apps:create wow-guild-bot

# Configure environment variables
dokku config:set wow-guild-bot DISCORD_TOKEN=your_discord_token
dokku config:set wow-guild-bot DISCORD_SERVER_ID=your_server_id
dokku config:set wow-guild-bot RAIDERIO_API_KEY=your_api_key

# Mount persistent storage for database and data files
dokku storage:ensure-directory wow-guild-bot
dokku storage:mount wow-guild-bot /var/lib/dokku/data/storage/wow-guild-bot:/app/data

# Deploy from git
git remote add dokku dokku@your-server:wow-guild-bot
git push dokku main

# Run initial data parsing (optional)
dokku run wow-guild-bot /app/wow_guild_bot parse
```

### Required Environment Variables for Production
- `DISCORD_TOKEN`: Discord bot token (required)
- `DISCORD_SERVER_ID`: Discord server ID (optional)
- `DISCORD_RULES_CHANNEL_ID`: Rules channel ID (optional)
- `RAIDERIO_API_KEY`: Raider.io API key (optional, increases rate limits)
- `RUST_LOG`: Log level (default: info)

### Data Persistence
- Database and data files are stored in `/app/data/` inside the container
- Mount this directory as a volume for persistence
- Required files (`uaguildlist.txt`, `addCharacters.txt`) should be placed in the mounted data directory